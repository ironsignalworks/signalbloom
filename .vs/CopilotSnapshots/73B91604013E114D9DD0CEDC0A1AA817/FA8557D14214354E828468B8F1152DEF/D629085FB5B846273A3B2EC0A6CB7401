export class MicAnalyser {
  ctx?: AudioContext;
  analyser?: AnalyserNode;
  data?: Uint8Array<ArrayBuffer>;
  gain = 1;

  async init() {
    if (this.ctx) return;
    this.ctx = new (window.AudioContext || (window as any).webkitAudioContext)();
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    const src = this.ctx.createMediaStreamSource(stream);
    this.analyser = this.ctx.createAnalyser();
    this.analyser.fftSize = 1024;
    this.analyser.smoothingTimeConstant = 0.8;
    src.connect(this.analyser);
    this.data = new Uint8Array(this.analyser.frequencyBinCount) as Uint8Array<ArrayBuffer>;
  }

  /** returns a smoothed 0..1 level */
  level(): number {
    if (!this.analyser || !this.data) return 0;
    this.analyser.getByteFrequencyData(this.data);
    let acc = 0;
    for (let i = 0; i < this.data.length; i++) acc += this.data[i];
    const avg = acc / this.data.length;            // 0..255
    return Math.min(1, (avg / 180) * this.gain);   // tuned for nice range
  }
}
